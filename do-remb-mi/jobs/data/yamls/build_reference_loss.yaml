run_name: pile-ref-build
platform: r1z1
gpu_type: a100_80gb
gpu_num: 8 
image: mosaicml/llm-foundry:2.0.1_cu118-latest
integrations:
  - integration_type: git_repo
    git_repo: zankner/llm-foundry
    git_branch: zack/do-remb-mi
    # git_commit: # OR use your commit hash
    pip_install: -e .[gpu]
    ssh_clone: false # Should be true if using a private repo
  - integration_type: pip_packages
    packages:
      - oci-cli
#
command: |
  pip install oci-cli
  cd llm-foundry
  composer do-remb-mi/scripts/data/build_reference_loss.py --batch-size {BATCH_SIZE} --num-domains {NUM_DOMAINS} --subset-domains {SUBSET_DOMAINS} --splits {SPLIT} --ref-model-size {MODEL_SIZE} --ref-model-ckpt {REF_MODEL_CKPT} --remote-base {REMOTE_BASE} --no-wandb
  if [ "$NODE_RANK" != "0" ]
  then
    exit 0
  fi
  oci os object bulk-upload --parallel-upload-count 500 -bn mosaicml-internal-doremi --src-dir /tmp/domains --prefix {UPLOAD_DIR}/ > /dev/null
